name: Deploy

on:
  workflow_dispatch:
    inputs:
      entity:
        required: true
        type: string
        description: "The entity to build the configuration for"
        options:
          - entity-1
          - entity-2
      environment:
        required: true
        type: string
        description: "The environment to build the configuration for"
        options:
          - dev
          - acc
          - prd
        default: dev

env:
  KONNECT_API_URL: https://eu.api.konghq.com
  KONNECT_CONTROL_PLANE_NAME: ${{ inputs.entity }}-${{ inputs.environment }}
  APIS_DIR: ${{ github.workspace }}/apis
  ENTITY_DIR: ${{ github.workspace }}/entities/${{ inputs.entity }}
  ENTITY_METADATA: ${{ github.workspace }}/entities/${{ inputs.entity }}/metadata.json
  ENTITY_KONG_DIR: ${{ github.workspace }}/entities/${{ inputs.entity }}/kong
  OUTPUT_DIR: ${{ github.workspace }}/.generated
  PLATFORM_DIR: ${{ github.workspace }}/platform

jobs:
  get-apis:
    runs-on: ubuntu-latest
    outputs:
      apis: ${{ steps.set-apis.outputs.apis }}
    steps:
      - uses: actions/checkout@v4
      - name: Get enabled APIs from metadata
        id: set-apis
        run: |
          APIS=$(jq -c '[.apis[] | select(.enabled==true) | . ]' $ENTITY_METADATA)
          echo "apis=$APIS" >> $GITHUB_OUTPUT

  deploy:
    needs:
      - get-apis
    runs-on: ubuntu-latest
    env:
      API_SPEC: ${{ github.workspace }}/apis/${{ matrix.api.name }}/${{ matrix.api.version }}/openapi.yaml
      API_KONG_DIR: ${{ github.workspace }}/apis/${{ matrix.api.name }}/${{ matrix.api.version }}/kong
    strategy:
      matrix:
        api: ${{ fromJson(needs.get-apis.outputs.apis) }}
    steps:
      - uses: actions/checkout@v4

      - uses: kong/setup-deck@v1

      - name: Source env.${{ inputs.environment }}.sh
        run: |
          set -a
          source ./env.${{ inputs.environment }}.sh
          set +a

          env | grep '^DECK_' >> "$GITHUB_ENV"

        working-directory: ${{ env.ENTITY_DIR }}

      - name: Setup extra decK variables
        run: |

          # Set the API URL
          api_url="https://${{ inputs.entity }}-${{ inputs.environment }}.${{ matrix.api.name }}.svc.cluster.local:8000"
          echo "DECK_API_URL=$api_url" >> $GITHUB_ENV

          # Set the API Name
          echo "DECK_API_NAME=${{ matrix.api.name }}" >> $GITHUB_ENV

          # Set the API Version
          echo "DECK_API_VERSION=${{ matrix.api.version }}" >> $GITHUB_ENV

          # Set the deck file namespace path prefix
          echo "DECK_FILE_NAMESPACE_PATH_PREFIX=${{ matrix.api.namespace }}" >> $GITHUB_ENV
      
      - name: Lint OpenAPI Spec
        run: |
          deck file lint -s $API_SPEC $PLATFORM_DIR/openapi.ruleset.yaml

      - name: Convert OpenAPI Spec to Kong declarative config
        run: |
          cat ${{ env.API_SPEC }} | deck file openapi2kong --generate-security -o $OUTPUT_DIR/kong.yaml

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts-${{ matrix.api.name }}-${{ matrix.api.version }}-${{ inputs.environment }}
      
      - name: Get a backup of the previous Kong Gateway configuration
        run: |
          deck gateway dump \
            --konnect-addr="${{ env.KONNECT_API_URL }}" \
            --konnect-token="${{ secrets.KONNECT_TOKEN }}" \
            --konnect-control-plane-name="${{ env.KONNECT_CONTROL_PLANE_NAME }}" -o kong_backup.yaml

      - name: Sync Kong Gateway configuration
        run: |
          deck gateway sync kong.yaml  \
            --konnect-addr="${{ env.KONNECT_API_URL }}" \
            --konnect-token="${{ secrets.KONNECT_TOKEN }}" \
            --konnect-control-plane-name="${{ env.KONNECT_CONTROL_PLANE_NAME }}"